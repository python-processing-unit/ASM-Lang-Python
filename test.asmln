IMPORT(prng)
IMPORT(csprng)
IMPORT(prime)
IMPORT(decimal)
IMPORT(path)
IMPORT(waveforms)

FUNC RUN_TESTS():INT{
    PRINT("Running library tests...")

    # PRNG reproducibility (LCG)
    prng.PRNG_SEED(1010)   # seed = 10
    INT: a = prng.PRNG_NEXT()
    prng.PRNG_SEED(1010)
    INT: b = prng.PRNG_NEXT()
    ASSERT( EQ(a, b) )

    PRINT("PRNG tests passed.")

    # CSPRNG reproducibility (ChaCha-based)
    csprng.CS_PRNG_SEED(101)  # seed = 5
    INT: x = csprng.CS_PRNG_NEXT()
    csprng.CS_PRNG_SEED(101)
    INT: y = csprng.CS_PRNG_NEXT()
    ASSERT( EQ(x, y) )

    PRINT("CSPRNG tests passed.")

    # Prime library tests
    # Basic primality checks
    ASSERT( EQ( prime.IS_PRIME(10), 1 ) )    # 2 is prime
    ASSERT( EQ( prime.IS_PRIME(11), 1 ) )    # 3 is prime
    ASSERT( EQ( prime.IS_PRIME(101), 1 ) )   # 5 is prime

    # NEXT_PRIME / PREV_PRIME
    ASSERT( EQ( prime.NEXT_PRIME(100), 101 ) )   # next prime after 4 is 5
    ASSERT( EQ( prime.PREV_PRIME(101), 11 ) )    # previous prime before 5 is 3

    # Mersenne prime check (p=3 -> 2^3-1 = 7, prime)
    ASSERT( EQ( prime.IS_MERSENNE_PRIME(11), 1 ) )

    # FACTOR: factor 10 (1010) -> [2 (10), 5 (101)]
    TNS: factors = prime.FACTOR(1010)
    ASSERT( EQ( TLEN(factors, 1), 10 ) )
    ASSERT( EQ( factors[1], 10 ) )
    ASSERT( EQ( factors[10], 101 ) )

    PRINT("Prime library tests passed.")

    # Decimal library tests
    ASSERT(EQ(decimal.INT_TO_DEC(100),"4"))
    ASSERT(EQ(decimal.DEC_TO_INT("4"),100))
    ASSERT(EQ(decimal.INT_TO_DEC(-100),"-4"))
    ASSERT(EQ(decimal.DEC_TO_INT("-4"),-100))

    PRINT("Decimal library tests passed.")

    # Path library tests
    ASSERT( EQ(path.NORMALIZE_PATH("a\b\c"), "a/b/c") )
    ASSERT( EQ(path.BASENAME("a/b/c.txt"), "c.txt") )
    ASSERT( EQ(path.EXTNAME("foo.bar"), "bar") )
    ASSERT( EQ(path.DELEXT("foo.bar"), "foo") )
    ASSERT( EQ(path.EXTNAME("foo"), "") )
    ASSERT( EQ(path.DELEXT("foo"), "foo") )

    PRINT("Path library tests passed.")

    # Waveform library tests
    INT: freq = 1100100      # 100
    INT: ms = 1010           # 10
    INT: amp = 1010          # 10
    INT: sr = 1111101000     # 1000
    INT: duty0 = 0
    INT: duty50 = 110010     # 50

    # Generators
    TNS: sq = waveforms.SQUARE(freq, ms, amp, sr)
    ASSERT(EQ(TLEN(sq, 1), ms))
    ASSERT(EQ(sq[1], amp))
    ASSERT(EQ(sq[110], NEG(amp)))

    TNS: saw = waveforms.SAWTOOTH(freq, ms, amp, sr)
    ASSERT(EQ(TLEN(saw, 1), ms))
    ASSERT(EQ(saw[1], NEG(amp)))
    ASSERT(EQ(saw[10], NEG(110)))   # -6
    ASSERT(EQ(saw[1010], 11010))    # 26

    TNS: tri = waveforms.TRIANGLE(freq, ms, amp, sr)
    ASSERT(EQ(TLEN(tri, 1), ms))
    ASSERT(EQ(tri[1], NEG(amp)))
    ASSERT(EQ(tri[110], amp))
    ASSERT(EQ(tri[1010], NEG(110)))

    TNS: pulse0 = waveforms.PULSE(freq, ms, amp, sr, duty0)
    ASSERT(EQ(TLEN(pulse0, 1), ms))
    ASSERT(EQ(pulse0[1], NEG(amp)))

    TNS: pulse50 = waveforms.PULSE(freq, ms, amp, sr, duty50)
    ASSERT(EQ(TLEN(pulse50, 1), ms))
    ASSERT(EQ(pulse50[1], amp))
    ASSERT(EQ(pulse50[110], NEG(amp)))

    TNS: sine0 = waveforms.SINE(freq, ms, 0, sr)
    ASSERT(EQ(TLEN(sine0, 1), ms))
    ASSERT(EQ(sine0[1], 0))
    ASSERT(EQ(sine0[1010], 0))

    # Filters
    TNS: env = waveforms.ENVELOPE_ADSR(SHAPE(sq), 10, 10, 10, 10)
    ASSERT(EQ(TLEN(env, 1), ms))
    ASSERT(EQ(env[1], 10))
    ASSERT(EQ(env[101], 10))
    ASSERT(EQ(env[1010], 1))

    TNS: filt_in = [0, 1, 10]
    TNS: low = waveforms.LOWPASS(filt_in, 1100100, 1100100)
    ASSERT(EQ(TLEN(low, 1), 11))
    ASSERT(EQ(low[1], 0))
    ASSERT(EQ(low[10], 1))
    ASSERT(EQ(low[11], 10))

    TNS: high = waveforms.HIGHPASS(filt_in, 1100100, 1100100)
    ASSERT(EQ(TLEN(high, 1), 11))
    ASSERT(EQ(high[1], 0))
    ASSERT(EQ(high[11], 0))

    PRINT("Waveform library tests passed.")

    # Extension tests (requires interpreter to be started with these extensions loaded)
    PRINT()

    PRINT("Running extension tests...")

    # win32 extension
    ASSERT(EQ(win32.WIN_SLEEP(0), 0))
    INT: ticks = win32.WIN_CALL("kernel32", "GetTickCount64", "", "I")
    ASSERT(GTE(ticks, 0))
    INT: last_err = win32.WIN_LAST_ERROR()
    ASSERT(GTE(last_err, 0))
    PRINT("win32 extension tests passed.")

    # networking extension (local-only; no external internet required)
    INT: udp = networking.UDP_BIND("127.0.0.1", 0)
    ASSERT(GT(udp, 0))
    ASSERT(EQ(networking.UDP_CLOSE(udp), 0))
    PRINT("networking extension tests passed.")

    # wasapi extension (read-only queries)
    STR: devname = wasapi.WASAPI_GET_DEFAULT_DEVICE_NAME()
    ASSERT(GT(SLEN(devname), 0))
    INT: volpct = wasapi.WASAPI_GET_MASTER_VOLUME()
    ASSERT(GTE(volpct, 0))
    ASSERT(LTE(volpct, 1100100))  # dec 100
    PRINT("wasapi extension tests passed.")

    # If we reach here all tests passed; print success code and return
    PRINT()
    
    PRINT("All tests passed.")
    RETURN(0)
}

IF( EQ(MAIN(), 1) ){ RUN_TESTS() }